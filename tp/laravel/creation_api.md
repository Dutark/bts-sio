# TodoList : (R√©-)√©crire les API du projet

Le But de notre application est de cr√©er des API Rest qui vont exposer la gestion de nos ```todos``` d√©fini en base de donn√©es

<!-- TOC -->

- [TodoList : (R√©-)√©crire les API du projet](#todolist--r√©-√©crire-les-api-du-projet)
    - [Introduction](#introduction)
    - [Cr√©ation du projet](#cr√©ation-du-projet)
    - [Installer Lumen](#installer-lumen)
    - [Cr√©er le nouveau Projet](#cr√©er-le-nouveau-projet)
    - [Initialisation](#initialisation)
    - [Tester votre application](#tester-votre-application)
    - [Gestion de la bose de donn√©es](#gestion-de-la-bose-de-donn√©es)
        - [Le script de cr√©ation / migration](#le-script-de-cr√©ation--migration)
    - [D√©clarer les routes](#d√©clarer-les-routes)

<!-- /TOC -->

## Introduction

Dans ce TP nous allons voir la cr√©ation d‚ÄôAPI pour le projet ¬´ TodoList ¬ª. Nous allons donc cr√©er un nouveau projet avec Laravel pour cr√©er des API qui permettront de :

- Lister les √©l√©ments dans la TodoList.
- Cr√©er un nouvel √©l√©ment dans la TodoList.
- Marquer un √©l√©ment comme ```terminer```.
- Supprimer un √©l√©ment.

## Cr√©ation du projet

Pour cr√©er des API Laravel est un peu ¬´ lourd ¬ª (dans notre cas, dans certains cas se choix est compl√®tement justifi√©). Nous allons donc utiliser son petit fr√®re Lumen. Lumen est un micro-framework reprenant les concepts de Laravel (et les m√™me briques). Mais en beaucoup plus petit et donc plus adapt√©s √† des micro-projets comme celui-ci.

## Installer Lumen

L‚Äôinstallation de Lumen est similaire √† celle de Laravel

```shell
composer global require "laravel/lumen-installer"
```

## Cr√©er le nouveau Projet

Maintenat que vous avez installer Lumen nous allons pouvoir utiliser la ligne de commande pour cr√©er un nouveau projet :

```shell
lumen new api-todo
```

‚úã Attention, le projet va √™tre cr√©√© dans le dossier api-todo dans le dossier courant.

## Initialisation

Contrairement √† un projet Laravel, les d√©pendances ```composer``` ne sont pas install√©s par d√©faut. Il faut donc les installer via la ligne de commande en faisant :

```shell
$ composer install
```

Le projet n‚Äô√©tant pas initialis√© nous allons devoir jouer quelques commande pour terminer l‚Äôinstallation :

```shell
$ mv .env.example .env
```

Contrairement √† Laravel, Lumen ne contient pas l‚Äôoutils permettant d‚Äôinitialiser la ¬´ secret key ¬ª n√©c√©ssaire √† la s√©curisation de votre application. Je pous propose par exemple de passer via la commande suivante :

```shell
$ openssl rand -base64 24
```

√©diter le fichier ```.env``` pour renseigner une valeur pour :

- ```APP_KEY``` (exemple ```APP_KEY="I82xtis8Tsur2"```)

## Tester votre application

Pour tester votre application avec Lumen sur votre poste, c‚Äôest un peu plus ¬´ complexe ¬ª qu‚Äôavec Laravel. Vous devez saisir la commande suivante :

```shell
$ php -S localhost:8000 -t ./public
```

Une fois lanc√© vous avez un serveur Web qui √©coute sur [le port 8000](http://localhost:8000)

ü§î Pourquoi Lumen n‚Äôint√®gre pas la commande ```php artisan serve``` ? La raison est plut√¥t logique, Lumen √©tant un ```micro framework``` il n‚Äôembarque pas toutes les options de base de Laravel. Options qui peuvent d‚Äôailleurs simplement √™tre remplac√©e.

## Gestion de la bose de donn√©es

### Le script de cr√©ation / migration

Contrairement √† la premi√®re version de notre application, nous allons stocker les donn√©es dans une Base de donn√©es. Qui dit base de donn√©es dit ¬´ ORM ¬ª et donc mapping objet. Pour rappel un ORM :

>> Un mapping objet-relationnel (en anglais object-relational mapping ou ORM) est une technique de programmation informatique qui cr√©e l'illusion d'une base de donn√©es orient√©e objet √† partir d'une base de donn√©es relationnelle en d√©finissant des correspondances entre cette base de donn√©es et les objets du langage utilis√©.

Pour rappel, le But de notre application est de cr√©er des API Rest qui vont exposer la gestion de nos ```todos``` d√©fini en base de donn√©es. La premi√®re √©tape est de cr√©er via la ligne de commande le ¬´ script ¬ª qui initialisera la structure de votre base de donn√©es. 

L‚Äôoption ```--create=todos``` permet d‚Äôindiquer le nom de la table √† cr√©er

```shell
php artisan make:migration create_todos_table --create=todos
```

‚úã Le contenu du fichier est fictif est la pour illustrer comment travailler. Nous allons le modifier pour mettre les informations relative √† notre base de donn√©es.

La commande √† cr√©√©r un nouveau fichier (dans mon cas) : ```database/migration/2017_11_02_205700_create_todos_table.php```

Dans le fichier cr√©er nous allons d√©finir notre sch√©ma (√† savoir la table) pour ajouter les 2 colonnes qui nous sont utiles ```texte``` et ```termine```. Le fichier apr√®s modification doit ressembler √† :

```php
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreateTodosTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('todos', function (Blueprint $table) {
            $table->increments('id');
            $table->string('texte');
            $table->boolean('termine');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('todos');
    }
}
```

## D√©clarer les routes

Pour commencer nous allons cr√©er les diff√©rentes ¬´ routes ¬ª (c‚Äôest √† dire les chemins d‚Äôacc√®s √† votre API). Dans notre applicaton nous avons 4 routes :

- Liste (/liste)
- Cr√©ation (/creation)
- Terminer (/terminer)
- Suppression (/suppression)